#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <mpi.h>
#include <stdbool.h>

#define MAX_LINE_LENGTH 256

int world_rank;
int world_size;
int local_sum = 0;
int global_sum = 0;

FILE* openFile(const char* filename, const char* mode)
{
    FILE* fp = fopen(filename, mode);
    if (fp == NULL) 
    { 
        fprintf(stderr, "Unable to open file!\n"); 
        MPI_Abort(MPI_COMM_WORLD, -1);
    }
    return fp;
}

void readFile()
{
    char line[MAX_LINE_LENGTH];
    int linecount = 0;
    FILE* fp = openFile("file2.txt", "r");

    // Cada processo lê apenas as linhas atribuídas a ele
    while (fgets(line, sizeof(line), fp))
    {
        if (linecount % world_size == world_rank) // Distribuindo as linhas entre os processos
        {
            int wordcount = 0;
            bool in_word = false;

            for (int i = 0; line[i] != '\0'; i++)
            {
                if (line[i] == ' ' || line[i] == '\n' || line[i] == '\t')
                {
                    if (in_word)
                    {
                        wordcount++;
                        in_word = false;
                    }
                } 
                else 
                {
                    in_word = true;
                }
            }
            if (in_word) wordcount++; // Conta a última palavra

            local_sum += wordcount;

            printf("---------------------------\n");
            printf("Process: %d\n", world_rank);
            printf("Line [%d]: %s\n", linecount, line);
            printf("Word count: %d\n", wordcount);
            printf("Local sum: %d\n", local_sum);
            printf("---------------------------\n");
        }
        linecount++;
    }

    fclose(fp);
}

int main(int argc, char** argv)
{
    MPI_Init(&argc, &argv);
    MPI_Comm_size(MPI_COMM_WORLD, &world_size);
    MPI_Comm_rank(MPI_COMM_WORLD, &world_rank);

    readFile();

    // Reduzindo o total de palavras de todos os processos
    MPI_Reduce(&local_sum, &global_sum, 1, MPI_INT, MPI_SUM, 0, MPI_COMM_WORLD);

    if (world_rank == 0)
    {
        printf("Global word count: %d\n", global_sum);
    }

    MPI_Finalize();
    return 0;
}
